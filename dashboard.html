<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SN SUB UMUM – 2026</title>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

  <style>
    :root{
      /* =========================
         MANUAL FONT SIZE SETTINGS
         ========================= */
      /* HEADER tabel "SEMUA ASSET" (KATEGORI MERK TIPE SN LOKASI STATUS ACTION) */
      --asset-th-size: 18px;      /* <-- kamu minta ubah size header SEMUA ASSET */
      --asset-th-letter: 8px;
      --asset-td-size: 16px;

      /* tabel kategori (kelola kategori) */
      --kategori-th-size: 18px;
      --kategori-th-letter: 8px;
      --kategori-td-size: 16px;

      /* form tambah barang + modal edit */
      --form-field-font: 22px;
      --form-button-font: 16px;

      /* =========================
         EXISTING SETTINGS
         ========================= */
      --sidebar-w: clamp(220px, 22vw, 300px);
      --pad-x: clamp(20px, 5.5vw, 100px);
      --pad-top: clamp(110px, 10vh, 140px);
      --pad-bot: clamp(90px, 10vh, 120px);

      --h2-size: clamp(38px, 5.5vw, 64px);

      --b-strong: clamp(4px, 0.6vw, 8px);
      --b-mid: clamp(3px, 0.5vw, 6px);

      --gap: clamp(32px, 6vw, 100px);
      --row-gap: clamp(14px, 2.2vw, 25px);

      --form-pad-y: clamp(40px, 5vw, 60px);
      --form-pad-x: clamp(36px, 5vw, 80px);

      --ui-top: clamp(14px, 2.2vw, 20px);
      --ui-right: clamp(14px, 2.2vw, 20px);

      /* (1) uiscale = 89% */
      --uiScale: 0.89;

      /* inverse zoom factor */
      --zoomInv: 1;

      --table-font: "Helvetica Neue", Helvetica, Arial, sans-serif;
      --table-value-weight: 600;
      --table-head-weight: 900;
    }

    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background:#fff;
      color:#000;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      overflow:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      background:
        linear-gradient(rgba(0,0,0,.04) 1px,transparent 1px),
        linear-gradient(90deg,rgba(0,0,0,.04) 1px,transparent 1px);
      background-size:45px 45px;
      pointer-events:none;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background:
        linear-gradient(#000 2px,transparent 2px),
        linear-gradient(90deg,#000 2px,transparent 2px);
      background-size:180px 180px;
      opacity:0.07;
      pointer-events:none;
    }

    /* UI SCALE wrapper */
    #app{
      position:relative;
      transform: scale(var(--uiScale));
      transform-origin: top left;
      width: calc(100% / var(--uiScale));
      height: calc(100% / var(--uiScale));
    }

    .sidebar{
      position:fixed;
      left:0;top:0;bottom:0;
      width:var(--sidebar-w);
      background:#000;
      color:#fff;
      padding:clamp(35px, 5vw, 60px) clamp(20px, 4vw, 50px);
      z-index:999;
      box-shadow:50px 0 80px rgba(0,0,0,0.4);
    }
    .logo{margin-bottom:clamp(70px, 10vh, 120px)}
    .logo h1{
      font-size:clamp(28px, 3.5vw, 38px);
      font-weight:900;
      letter-spacing:-3px;
      line-height:0.95;
      background:#fff;
      color:#000;
      padding:clamp(16px, 2.5vw, 25px) clamp(18px, 3vw, 35px);
      display:inline-block;
      border:clamp(3px, 0.5vw, 6px) solid #000;
      box-shadow:12px 12px 0 #000;
    }

    .menu-item{
      font-size:clamp(14px, 1.7vw, 17px);
      font-weight:900;
      letter-spacing:-0.3px;
      margin:clamp(18px, 2.6vw, 30px) 0;
      cursor:pointer;
      transition:all .35s;
      opacity:0.8;
      position:relative;
      padding-bottom:8px;
    }
    .menu-item:hover,.menu-item.active{opacity:1}
    .menu-item::after{
      content:"";
      position:absolute;
      left:0;
      bottom:0;
      width:0;
      height:3px;
      background:#fff;
      transition:all .35s;
    }
    .menu-item:hover::after,.menu-item.active::after{width:40px}

    .main{
      position:fixed;
      left:var(--sidebar-w);
      top:0;
      right:0;
      bottom:0;
      overflow:hidden;
      z-index:1;
    }

    #scrollArea{
      position:absolute;
      inset:0;
      overflow-y:auto;
      overflow-x:hidden;
      padding:var(--pad-top) var(--pad-x) var(--pad-bot);
    }

    #userInfoBox{
      position:absolute;
      top:var(--ui-top);
      right:var(--ui-right);
      z-index:5000;
      pointer-events:auto;

      background:rgba(255,255,255,0.92);
      padding:clamp(12px, 1.6vw, 16px) clamp(18px, 2.4vw, 28px);
      border:clamp(3px, 0.5vw, 6px) solid #000;
      font-size:clamp(11px, 1.1vw, 13px);
      letter-spacing:clamp(3px, 0.8vw, 6px);
      font-weight:900;
      display:flex;
      align-items:center;
      gap:clamp(14px, 2vw, 24px);
      max-width:calc(100vw - var(--sidebar-w) - (var(--pad-x) * 2));

      opacity:1;
      transform:translateY(0);
      transition:opacity .08s linear, transform .08s linear;
      will-change:opacity, transform;
    }

    .logout-btn{
      background:none;
      border:clamp(3px, 0.5vw, 6px) solid #000;
      padding:clamp(10px, 1.4vw, 12px) clamp(18px, 2.2vw, 28px);
      font-size:clamp(11px, 1.1vw, 13px);
      font-weight:900;
      letter-spacing:clamp(3px, 0.8vw, 5px);
      cursor:pointer;
      transition:.35s;
      white-space:nowrap;
      font-family:var(--table-font);
    }
    .logout-btn:hover{background:#000;color:#fff}

    .bottombar{
      position:absolute;
      left:0;
      right:0;
      bottom:clamp(0px, 0.8vw, 6px);
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:4500;
    }
    .footer{
      background:transparent;
      border:none;
      padding:0;
      font-size:clamp(11px, 1.2vw, 14px);
      letter-spacing:clamp(4px, 1.0vw, 8px);
      font-weight:900;
      line-height:1;
      color:#000;
      opacity:0;
      transform:translateY(8px);
      transition:opacity .15s linear, transform .15s linear;
      will-change:opacity, transform;
      font-family:var(--table-font);
    }

    .content{display:none}
    .content.active{display:block}

    h2{
      font-size:var(--h2-size);
      font-weight:900;
      letter-spacing:-6px;
      line-height:0.95;
      margin-bottom:clamp(45px, 6vw, 80px);
    }

    /* ===== BASE TABLE ===== */
    table{
      width:100%;
      table-layout:fixed;
      border-collapse:separate;
      border-spacing:0 calc(var(--row-gap) * var(--zoomInv));
      font-family:var(--table-font);
    }
    th, td{
      text-align:center;
      vertical-align:middle;
      word-break:break-word;
    }
    td{
      font-weight:var(--table-value-weight);
      padding: calc(20px * var(--zoomInv)) 0;
      border-bottom-style: solid;
      border-bottom-color: #000;
      border-bottom-width: calc(var(--b-mid) * var(--zoomInv));
    }

    td.action-cell{ padding: calc(14px * var(--zoomInv)) 0; }
    td.action-cell .action-wrap{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:clamp(8px, 1.2vw, 14px);
    }
    td.action-cell .btn{ margin-right:0 !important; }

    /* ===== MANUAL FONT: ASSET TABLE (SEMUA ASSET + RUSAK/HILANG) ===== */
    #assets thead th,
    #rusak thead th{
      font-size: calc(var(--asset-th-size) * var(--zoomInv));
      letter-spacing: calc(var(--asset-th-letter) * var(--zoomInv));
      font-weight: var(--table-head-weight);
      text-transform: uppercase;
      opacity: 0.75;
      padding-bottom: calc(22px * var(--zoomInv));
    }
    #assets tbody td,
    #rusak tbody td{
      font-size: calc(var(--asset-td-size) * var(--zoomInv));
    }

    /* ===== MANUAL FONT: KATEGORI TABLE ===== */
    #kelolaKategoriSection thead th{
      font-size: calc(var(--kategori-th-size) * var(--zoomInv));
      letter-spacing: calc(var(--kategori-th-letter) * var(--zoomInv));
      font-weight: var(--table-head-weight);
      text-transform: uppercase;
      opacity: 0.75;
      padding-bottom: calc(18px * var(--zoomInv));
    }
    #kelolaKategoriSection tbody td{
      font-size: calc(var(--kategori-td-size) * var(--zoomInv));
    }

    /* ===== FORM ===== */
    .form-box{
      background:#fafafa;
      padding:var(--form-pad-y) var(--form-pad-x);
      border:var(--b-strong) solid #000;
    }

    #add .form-box input,
    #add .form-box select,
    #add .form-box textarea,
    #editModal .form-box input,
    #editModal .form-box select,
    #editModal .form-box textarea{
      width:100%;
      padding:clamp(16px, 2vw, 20px) 0;
      background:none;
      border:none;
      border-bottom:var(--b-mid) solid #000;
      font-size: calc(var(--form-field-font) * var(--zoomInv));
      margin:clamp(22px, 4vw, 40px) 0;
      outline:none;
      text-align:center;
      font-family:var(--table-font);
      font-weight:600;
    }

    #add .form-box button.btn,
    #editModal .form-box button.btn{
      font-size: calc(var(--form-button-font) * var(--zoomInv));
      font-family:var(--table-font);
    }

    .add-layout{
      display:flex;
      gap:var(--gap);
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:center;
    }
    .left-tambah-barang{
      flex:1 1 600px;
      min-width:min(600px, 100%);
      max-width:900px;
    }
    .right-kelola-kategori{
      flex:1 1 500px;
      display:none;
      flex-direction:column;
      min-width:min(500px, 100%);
    }

    .right-kelola-kategori .form-box{
      padding:var(--form-pad-y) clamp(28px, 4vw, 70px);
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .right-kelola-kategori h3{
      font-size:clamp(20px, 2.2vw, 26px);
      margin-bottom:clamp(18px, 2.6vw, 30px);
      letter-spacing:-2px;
      text-align:center;
      font-weight:900;
      font-family:var(--table-font);
    }

    .btn{
      padding:clamp(12px, 1.8vw, 16px) clamp(26px, 5vw, 55px);
      background:#000;
      color:#fff;
      font-weight:900;
      letter-spacing:clamp(3px, 0.9vw, 5px);
      border:none;
      cursor:pointer;
      transition:.35s;
      margin-right:15px;
      font-family:var(--table-font);
    }
    .btn:hover{background:#ff0000}
    .btn-small{
      padding:clamp(9px, 1.2vw, 10px) clamp(14px, 2.6vw, 25px);
      font-size:clamp(11px, 1.1vw, 13px);
    }

    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      z-index:9999;
      align-items:center;
      justify-content:center;
      overflow:auto;
    }
    .modal.active{display:flex}
    .modal-box{
      background:#fafafa;
      padding:clamp(40px, 6vw, 80px);
      width:90%;
      max-width:900px;
      border:var(--b-strong) solid #000;
      position:relative;
    }
    .close-modal{
      position:absolute;
      top:clamp(18px, 3vw, 30px);
      right:clamp(22px, 4vw, 50px);
      font-size:clamp(28px, 4vw, 40px);
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="sidebar">
      <div class="logo"><h1>INVENTARIS<br>KOMPUTER</h1></div>

      <div class="menu-item active" data-page="home">HOME</div>
      <div class="menu-item" data-page="assets">SEMUA ASSET</div>
      <div class="menu-item" id="menuAdd" style="display:none" data-page="add">+ TAMBAH BARANG</div>
      <div class="menu-item" data-page="rusak">RUSAK / HILANG</div>
    </div>

    <div class="main">
      <div class="user-info" id="userInfoBox">
        <span id="userInfo">LOADING...</span>
        <button class="logout-btn" onclick="firebase.auth().signOut().then(()=>location.href='login.html')">LOGOUT</button>
      </div>

      <div id="scrollArea">
        <div id="home" class="content active">
          <h2>DASHBOARD<br>2026</h2>
        </div>

        <div id="assets" class="content">
          <h2>SEMUA<br>ASSET</h2>
          <table>
            <thead>
              <tr>
                <th>KATEGORI</th>
                <th>MERK</th>
                <th>TIPE</th>
                <th>SN</th>
                <th>LOKASI</th>
                <th>STATUS</th>
                <th id="aksiHeader" style="display:none">ACTION</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <div id="add" class="content">
          <h2>TAMBAH<br>BARANG</h2>

          <div class="add-layout">
            <div class="left-tambah-barang">
              <div class="form-box">
                <select id="kategori"><option value="">— PILIH KATEGORI —</option></select>
                <input type="text" id="merk" placeholder="MERK">
                <input type="text" id="tipe" placeholder="TIPE / SPESIFIKASI">
                <input type="text" id="sn" placeholder="SERIAL NUMBER (opsional)">
                <input type="text" id="lokasi" placeholder="LOKASI / RUANGAN">
                <select id="status">
                  <option value="OPERATIONAL">OPERATIONAL</option>
                  <option value="RUSAK">RUSAK</option>
                  <option value="PERBAIKAN">DALAM PERBAIKAN</option>
                  <option value="HILANG">HILANG</option>
                </select>
                <textarea id="keterangan" placeholder="KETERANGAN TAMBAHAN (opsional)"></textarea>
                <br><br>
                <button class="btn" onclick="saveData()">SIMPAN BARANG</button>
              </div>
            </div>

            <div class="right-kelola-kategori" id="kelolaKategoriSection">
              <div class="form-box">
                <h3>KELOLA KATEGORI</h3>

                <div class="tambah-kategori-controls">
                  <div id="formTambahKategori" style="display:none;margin-bottom:30px;">
                    <input type="text" id="namaKategoriBaru" placeholder="NAMA KATEGORI BARU">
                    <br><br>
                    <button class="btn btn-small" onclick="addKategori()">TAMBAH</button>
                    <button class="btn btn-small" style="background:#999;" onclick="document.getElementById('formTambahKategori').style.display='none'">BATAL</button>
                  </div>

                  <button class="btn btn-small" onclick="document.getElementById('formTambahKategori').style.display='block'; document.getElementById('namaKategoriBaru').focus();">+ TAMBAH BARU</button>
                </div>

                <table>
                  <thead>
                    <tr>
                      <th>NO</th>
                      <th>KATEGORI</th>
                      <th>ACTION</th>
                    </tr>
                  </thead>
                  <tbody id="kategoriTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="rusak" class="content">
          <h2>RUSAK /<br>HILANG</h2>
          <table>
            <thead>
              <tr>
                <th>KATEGORI</th>
                <th>MERK</th>
                <th>TIPE</th>
                <th>SN</th>
                <th>LOKASI</th>
                <th>STATUS</th>
                <th>ACTION</th>
              </tr>
            </thead>
            <tbody id="rusakTableBody">
              <tr>
                <td colspan="7" style="text-align:center;padding:180px;opacity:0.3;font-size:28px;">
                  BELUM ADA DATA RUSAK / HILANG<br>
                  <span style="font-size:16px;opacity:0.6;">(Fitur ini sedang dikembangkan)</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="bottombar">
        <div class="footer" id="footerBox">SN SUB UMUM – INTERNAL INVENTORY SYSTEM 2026</div>
      </div>
    </div>

    <div class="modal" id="editModal">
      <div class="modal-box">
        <span class="close-modal" onclick="closeEditModal()">×</span>
        <h2>EDIT<br>BARANG</h2>
        <div class="form-box">
          <select id="editKategori"></select>
          <input type="text" id="editMerk" placeholder="MERK">
          <input type="text" id="editTipe" placeholder="TIPE / SPESIFIKASI">
          <input type="text" id="editSn" placeholder="SERIAL NUMBER (opsional)">
          <input type="text" id="editLokasi" placeholder="LOKASI / RUANGAN">
          <select id="editStatus">
            <option value="OPERATIONAL">OPERATIONAL</option>
            <option value="RUSAK">RUSAK</option>
            <option value="PERBAIKAN">DALAM PERBAIKAN</option>
            <option value="HILANG">HILANG</option>
          </select>
          <textarea id="editKeterangan" placeholder="KETERANGAN TAMBAHAN (opsional)"></textarea>
          <br><br>
          <button class="btn" onclick="saveEditData()">SIMPAN PERUBAHAN</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== UI SCALE ===== */
    function applyUIScale(scale) {
      document.documentElement.style.setProperty("--uiScale", String(scale));
    }
    function calcAutoScale() {
      const physicalW = window.innerWidth * window.devicePixelRatio;
      const physicalH = window.innerHeight * window.devicePixelRatio;

      const targetW = 1920, targetH = 1080;
      const sW = physicalW / targetW;
      const sH = physicalH / targetH;

      /* (2) Math.min = 94% => 0.94 */
      const s = Math.min(0.94, sW, sH);

      /* (3) Math.max = 84% => 0.84 */
      return Number(Math.max(0.84, s).toFixed(3));
    }

    applyUIScale(calcAutoScale());
    window.addEventListener("resize", () => applyUIScale(calcAutoScale()), { passive: true });

    /* ===== inverse zoom ===== */
    const __zoomBaseDpr = window.devicePixelRatio || 1;
    function updateZoomInv() {
      const dpr = window.devicePixelRatio || 1;
      const inv = __zoomBaseDpr / dpr;
      const clamped = Math.max(0.75, Math.min(1.35, inv));
      document.documentElement.style.setProperty("--zoomInv", clamped.toFixed(3));
    }
    window.addEventListener("resize", updateZoomInv, { passive: true });
    setInterval(updateZoomInv, 600);
    updateZoomInv();

    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCGyH-yVAgQU4iJ1tIz3cpWiWa65BdMsJ8",
      authDomain: "inventariskomputer.firebaseapp.com",
      databaseURL: "https://inventariskomputer-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "inventariskomputer",
      storageBucket: "inventariskomputer.firebasestorage.app",
      messagingSenderId: "915927761008",
      appId: "1:915927761008:web:a4b2e71159d00501fdf4b5"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    const inventarisRef = db.ref("inventaris");
    const kategoriRef = db.ref("kategori");
    const kategoriKeysRef = db.ref("kategoriKeys");

    let role = "staff";
    let currentEditKey = null;

    let inventarisHandler = null;
    let kategoriTableHandler = null;

    function $(id) { return document.getElementById(id); }

    /* ===== kategori unique ===== */
    function normalizeKategoriKey(s) {
      const norm = String(s || "").trim().toLowerCase().replace(/\s+/g, " ");
      return norm.replace(/[.#$\[\]\/]/g, "_").slice(0, 80);
    }

    async function claimKategoriKey(namaKey, kategoriId) {
      const ref = kategoriKeysRef.child(namaKey);
      const tx = await ref.transaction(current => {
        if (current === null) return kategoriId;
        return;
      });
      return { committed: tx.committed, owner: tx.snapshot.val() };
    }

    let kategoriKeysSynced = false;

    async function syncKategoriKeysFromExistingKategori() {
      if (kategoriKeysSynced) return;
      if (role !== "admin") return;

      const snap = await kategoriRef.once("value");
      const data = snap.val() || {};
      const updates = {};
      const duplicates = [];

      for (const [id, v] of Object.entries(data)) {
        const nama = (v && v.nama) ? String(v.nama).trim() : "";
        if (!nama) continue;

        const namaKey = (v && v.namaKey) ? String(v.namaKey) : normalizeKategoriKey(nama);

        if (!v.namaKey || v.namaKey !== namaKey) updates["kategori/" + id + "/namaKey"] = namaKey;

        const res = await claimKategoriKey(namaKey, id);
        if (res.owner !== id) duplicates.push({ id, nama, namaKey, owner: res.owner });
      }

      if (Object.keys(updates).length) await db.ref().update(updates);

      kategoriKeysSynced = true;

      if (duplicates.length) {
        console.warn("DUPLICATE KATEGORI DETECTED:", duplicates);
        alert("PERINGATAN: ada kategori duplikat dari data lama. Rapikan (rename/hapus) di KELOLA KATEGORI.");
      }
    }

    async function ensureDefaultKategoriIfEmpty() {
      if (role !== "admin") return;

      const snap = await kategoriRef.once("value");
      if (snap.exists() && Object.keys(snap.val() || {}).length > 0) return;

      const defaults = ["Laptop","PC Desktop","Monitor","Printer","Aksesoris","Jaringan","Lainnya"];

      for (const nama of defaults) {
        const namaKey = normalizeKategoriKey(nama);
        const newId = kategoriRef.push().key;

        const claim = await claimKategoriKey(namaKey, newId);
        if (!claim.committed || claim.owner !== newId) continue;

        try {
          await kategoriRef.child(newId).set({ nama, namaKey, createdAt: new Date().toISOString() });
        } catch (e) {
          const cur = (await kategoriKeysRef.child(namaKey).once("value")).val();
          if (cur === newId) await kategoriKeysRef.child(namaKey).remove();
          throw e;
        }
      }
    }

    function tdText(v) {
      const td = document.createElement("td");
      td.textContent = (v === undefined || v === null) ? "" : String(v);
      return td;
    }

    function makeBtn(text, className, onClick) {
      const b = document.createElement("button");
      b.className = className;
      b.textContent = text;
      b.type = "button";
      b.addEventListener("click", onClick);
      return b;
    }

    /* ===== Menu routing ===== */
    let menuWired = false;

    function setActiveMenu(pageId) {
      document.querySelectorAll(".menu-item").forEach(m => m.classList.remove("active"));
      const el = document.querySelector('.menu-item[data-page="' + pageId + '"]');
      if (el) el.classList.add("active");
    }

    function showPage(pageId) {
      if (pageId === "add" && role !== "admin") {
        alert("AKSES DITOLAK (ADMIN ONLY)");
        pageId = "home";
      }

      document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
      const page = $(pageId);
      if (page) page.classList.add("active");

      setActiveMenu(pageId);

      if (pageId === "assets") startInventarisListener();
      if (pageId === "add") {
        loadKategoriDropdown();
        if (role === "admin") startKategoriTableListener();
      }

      setUserInfoAutoHide(pageId === "add");
      requestAnimationFrame(scrollUIUpdate);
    }

    function wireMenu() {
      if (menuWired) return;
      menuWired = true;
      document.querySelectorAll(".menu-item[data-page]").forEach(el => {
        el.addEventListener("click", () => showPage(el.dataset.page));
      });
    }

    async function loadKategoriDropdown() {
      const select = $("kategori");
      const editSelect = $("editKategori");

      if (select) select.innerHTML = '<option value="">— PILIH KATEGORI —</option>';
      if (editSelect) editSelect.innerHTML = "";

      const snap = await kategoriRef.once("value");
      const data = snap.val() || {};

      const list = Object.entries(data).map(([id, v]) => ({
        id,
        nama: (v && v.nama) ? v.nama : "Unknown"
      })).sort((a,b) => a.nama.localeCompare(b.nama, "id", { sensitivity: "base" }));

      for (const row of list) {
        if (select) {
          const opt1 = document.createElement("option");
          opt1.value = row.nama;
          opt1.textContent = row.nama;
          select.appendChild(opt1);
        }
        if (editSelect) {
          const opt2 = document.createElement("option");
          opt2.value = row.nama;
          opt2.textContent = row.nama;
          editSelect.appendChild(opt2);
        }
      }
    }

    function startKategoriTableListener() {
      const tbody = $("kategoriTableBody");
      if (!tbody) return;

      if (kategoriTableHandler) kategoriRef.off("value", kategoriTableHandler);

      kategoriTableHandler = (snap) => {
        const data = snap.val() || {};
        const list = Object.entries(data).map(([id, v]) => ({
          id,
          nama: (v && v.nama) ? v.nama : "Unknown"
        })).sort((a,b) => a.nama.localeCompare(b.nama, "id", { sensitivity: "base" }));

        tbody.innerHTML = "";

        if (list.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 3;
          td.style.textAlign = "center";
          td.style.padding = "60px";
          td.style.opacity = "0.5";
          td.textContent = "BELUM ADA KATEGORI";
          tr.appendChild(td);
          tbody.appendChild(tr);
          requestAnimationFrame(scrollUIUpdate);
          return;
        }

        let no = 1;
        for (const row of list) {
          const tr = document.createElement("tr");
          tr.appendChild(tdText(no++));
          tr.appendChild(tdText(row.nama));

          const actionTd = document.createElement("td");
          actionTd.className = "action-cell";

          const wrap = document.createElement("div");
          wrap.className = "action-wrap";

          const editB = makeBtn("EDIT", "btn btn-small", () => editKategori(row.id, row.nama));
          const delB = makeBtn("DELETE", "btn btn-small", () => deleteKategori(row.id, row.nama));
          delB.style.background = "#ff0000";

          wrap.appendChild(editB);
          wrap.appendChild(delB);
          actionTd.appendChild(wrap);

          tr.appendChild(actionTd);
          tbody.appendChild(tr);
        }

        requestAnimationFrame(scrollUIUpdate);
      };

      kategoriRef.on("value", kategoriTableHandler);
    }

    function startInventarisListener() {
      const tbody = $("tableBody");
      if (!tbody) return;

      if (inventarisHandler) inventarisRef.off("value", inventarisHandler);

      inventarisHandler = (snap) => {
        tbody.innerHTML = "";

        if (!snap.exists()) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = (role === "admin") ? 7 : 6;
          td.style.textAlign = "center";
          td.style.padding = "180px";
          td.style.fontSize = "28px";
          td.style.opacity = "0.2";
          td.textContent = "NO DATA";
          tr.appendChild(td);
          tbody.appendChild(tr);
          requestAnimationFrame(scrollUIUpdate);
          return;
        }

        snap.forEach(c => {
          const i = c.val() || {};
          const key = c.key;

          const tr = document.createElement("tr");
          tr.appendChild(tdText(i.kategori || "LAINNYA"));
          tr.appendChild(tdText(i.merk || ""));
          tr.appendChild(tdText(i.tipe || ""));
          tr.appendChild(tdText(i.sn || "-"));
          tr.appendChild(tdText(i.lokasi || ""));
          tr.appendChild(tdText(i.status || ""));

          if (role === "admin") {
            const actionTd = document.createElement("td");
            actionTd.className = "action-cell";

            const wrap = document.createElement("div");
            wrap.className = "action-wrap";

            const editB = makeBtn("EDIT", "btn", () => openEditModal(key, i));
            editB.style.padding = "12px 30px";
            editB.style.fontSize = "13px";

            const delB = makeBtn("DELETE", "btn", async () => {
              const ok = confirm("DELETE?");
              if (!ok) return;
              await inventarisRef.child(key).remove();
            });
            delB.style.background = "#ff0000";
            delB.style.padding = "12px 30px";
            delB.style.fontSize = "13px";

            wrap.appendChild(editB);
            wrap.appendChild(delB);

            actionTd.appendChild(wrap);
            tr.appendChild(actionTd);
          }

          tbody.appendChild(tr);
        });

        requestAnimationFrame(scrollUIUpdate);
      };

      inventarisRef.on("value", inventarisHandler);
    }

    async function addKategori() {
      if (role !== "admin") return alert("ADMIN ONLY");

      await syncKategoriKeysFromExistingKategori();

      const raw = ($("namaKategoriBaru").value || "");
      const nama = String(raw).trim();
      if (!nama) return alert("ISI NAMA KATEGORI!");

      const namaKey = normalizeKategoriKey(nama);
      const newId = kategoriRef.push().key;

      const claim = await claimKategoriKey(namaKey, newId);
      if (!claim.committed || claim.owner !== newId) {
        alert("KATEGORI SUDAH ADA (DUPLIKAT)!");
        return;
      }

      try {
        await kategoriRef.child(newId).set({ nama, namaKey, createdAt: new Date().toISOString() });
      } catch (e) {
        const cur = (await kategoriKeysRef.child(namaKey).once("value")).val();
        if (cur === newId) await kategoriKeysRef.child(namaKey).remove();
        alert("GAGAL MENAMBAH KATEGORI: " + (e && e.message ? e.message : e));
        return;
      }

      alert("KATEGORI DITAMBAHKAN!");
      $("namaKategoriBaru").value = "";
      $("formTambahKategori").style.display = "none";
      loadKategoriDropdown();
    }

    async function editKategori(id, namaSaatIni) {
      if (role !== "admin") return;

      await syncKategoriKeysFromExistingKategori();

      const input = prompt("EDIT NAMA KATEGORI:", namaSaatIni);
      if (input === null) return;

      const nama = String(input).trim();
      if (!nama) return alert("NAMA KATEGORI TIDAK BOLEH KOSONG!");

      const snap = await kategoriRef.child(id).once("value");
      if (!snap.exists()) return alert("KATEGORI TIDAK DITEMUKAN!");

      const old = snap.val() || {};
      const oldKey = old.namaKey || normalizeKategoriKey(old.nama || namaSaatIni || "");
      const newKey = normalizeKategoriKey(nama);

      if (newKey === oldKey) {
        await kategoriRef.child(id).update({ nama });
        alert("KATEGORI DIUPDATE!");
        loadKategoriDropdown();
        return;
      }

      const claim = await claimKategoriKey(newKey, id);
      if (claim.owner !== id) {
        alert("NAMA KATEGORI SUDAH ADA (DUPLIKAT)!");
        return;
      }

      try {
        const updates = {};
        updates["kategori/" + id + "/nama"] = nama;
        updates["kategori/" + id + "/namaKey"] = newKey;
        if (oldKey) updates["kategoriKeys/" + oldKey] = null;
        await db.ref().update(updates);
      } catch (e) {
        const cur = (await kategoriKeysRef.child(newKey).once("value")).val();
        if (cur === id) await kategoriKeysRef.child(newKey).remove();
        alert("GAGAL UPDATE: " + (e && e.message ? e.message : e));
        return;
      }

      alert("KATEGORI DIUPDATE!");
      loadKategoriDropdown();
    }

    async function deleteKategori(id, nama) {
      if (role !== "admin") return;

      await syncKategoriKeysFromExistingKategori();

      const ok = confirm("YAKIN HAPUS KATEGORI INI?\n\n" + (nama || ""));
      if (!ok) return;

      const snap = await kategoriRef.child(id).once("value");
      if (!snap.exists()) return;

      const val = snap.val() || {};
      const namaKey = val.namaKey || normalizeKategoriKey(val.nama || nama || "");

      const updates = {};
      updates["kategori/" + id] = null;
      if (namaKey) updates["kategoriKeys/" + namaKey] = null;

      await db.ref().update(updates);

      alert("KATEGORI DIHAPUS!");
      loadKategoriDropdown();
    }

    async function openEditModal(key, data) {
      if (role !== "admin") return;
      currentEditKey = key;

      await loadKategoriDropdown();

      $("editKategori").value = data.kategori || "LAINNYA";
      $("editMerk").value = data.merk || "";
      $("editTipe").value = data.tipe || "";
      $("editSn").value = data.sn || "";
      $("editLokasi").value = data.lokasi || "";
      $("editStatus").value = data.status || "OPERATIONAL";
      $("editKeterangan").value = data.keterangan || "";

      $("editModal").classList.add("active");
    }

    function closeEditModal() {
      $("editModal").classList.remove("active");
      currentEditKey = null;
    }

    async function saveEditData() {
      if (role !== "admin" || !currentEditKey) return;

      const d = {
        kategori: $("editKategori").value || "LAINNYA",
        merk: $("editMerk").value.trim(),
        tipe: $("editTipe").value.trim(),
        sn: $("editSn").value.trim() || "-",
        lokasi: $("editLokasi").value.trim(),
        status: $("editStatus").value,
        keterangan: $("editKeterangan").value.trim() || "-"
      };

      if (!d.merk || !d.tipe || !d.lokasi) return alert("LENGKAPI DATA!");

      await inventarisRef.child(currentEditKey).update(d);
      alert("BARANG BERHASIL DIUPDATE!");
      closeEditModal();
    }

    async function saveData() {
      if (role !== "admin") return alert("ADMIN ONLY");

      const d = {
        kategori: $("kategori").value || "LAINNYA",
        merk: $("merk").value.trim(),
        tipe: $("tipe").value.trim(),
        sn: $("sn").value.trim() || "-",
        lokasi: $("lokasi").value.trim(),
        status: $("status").value,
        keterangan: $("keterangan").value.trim() || "-",
        tanggal_input: new Date().toISOString().split("T")[0]
      };

      if (!d.kategori || !d.merk || !d.tipe || !d.lokasi) return alert("LENGKAPI DATA!");

      await inventarisRef.push(d);

      alert("BARANG BERHASIL DITAMBAHKAN!");
      $("merk").value = "";
      $("tipe").value = "";
      $("sn").value = "";
      $("lokasi").value = "";
      $("keterangan").value = "";

      showPage("assets");
    }

    /* ===== autohide user info + footer show bottom ===== */
    const scrollUI = {
      inited: false,
      ticking: false,
      userHide: false,
      scroller: null,
      userBox: null,
      footerBox: null
    };

    function initScrollUI() {
      if (scrollUI.inited) return;

      scrollUI.scroller = document.getElementById("scrollArea");
      scrollUI.userBox = document.getElementById("userInfoBox");
      scrollUI.footerBox = document.getElementById("footerBox");

      if (!scrollUI.scroller) return;
      scrollUI.inited = true;

      scrollUI.scroller.addEventListener("scroll", () => {
        if (!scrollUI.ticking) {
          scrollUI.ticking = true;
          requestAnimationFrame(scrollUIUpdate);
        }
      }, { passive: true });

      scrollUIUpdate();
    }

    function scrollUIUpdate() {
      const scroller = scrollUI.scroller;
      const userBox = scrollUI.userBox;
      const footerBox = scrollUI.footerBox;

      if (!scroller) { scrollUI.ticking = false; return; }

      if (userBox) {
        if (scrollUI.userHide) {
          const HIDE_AT = 210;
          const t = Math.max(0, Math.min(HIDE_AT, scroller.scrollTop));
          const p = 1 - (t / HIDE_AT);
          const shift = t * 0.9;

          userBox.style.opacity = String(p);
          userBox.style.transform = "translateY(" + (-shift) + "px)";
          userBox.style.pointerEvents = (p < 0.05) ? "none" : "auto";
        } else {
          userBox.style.opacity = "1";
          userBox.style.transform = "translateY(0px)";
          userBox.style.pointerEvents = "auto";
        }
      }

      if (footerBox) {
        const distToBottom = (scroller.scrollHeight - scroller.clientHeight) - scroller.scrollTop;
        const show = distToBottom <= 2;
        footerBox.style.opacity = show ? "1" : "0";
        footerBox.style.transform = show ? "translateY(0px)" : "translateY(8px)";
      }

      scrollUI.ticking = false;
    }

    function setUserInfoAutoHide(enabled) {
      scrollUI.userHide = !!enabled;
      initScrollUI();
      requestAnimationFrame(scrollUIUpdate);
    }

    /* ===== Auth + role gate ===== */
    auth.onAuthStateChanged(async (u) => {
      if (!u) { location.href = "login.html"; return; }
      if (!u.emailVerified) { await auth.signOut(); location.href = "login.html?msg=verify"; return; }

      const userSnap = await db.ref("users/" + u.uid).once("value");
      const userData = userSnap.val();

      if (!userData) {
        await auth.signOut();
        alert("Profil user tidak ditemukan di database. Silakan register ulang / hubungi admin.");
        location.href = "login.html";
        return;
      }

      role = userData.role || "staff";
      $("userInfo").innerText = (userData.nama || "USER") + " – " + role.toUpperCase();

      if (role === "admin") {
        document.getElementById("menuAdd").style.display = "block";
        document.getElementById("aksiHeader").style.display = "table-cell";
        document.getElementById("kelolaKategoriSection").style.display = "block";
      } else {
        document.getElementById("menuAdd").style.display = "none";
        document.getElementById("aksiHeader").style.display = "none";
        document.getElementById("kelolaKategoriSection").style.display = "none";
      }

      wireMenu();
      await loadKategoriDropdown();
      initScrollUI();

      if (role === "admin") {
        try {
          await syncKategoriKeysFromExistingKategori();
          await ensureDefaultKategoriIfEmpty();
        } catch (e) {
          console.error("ADMIN INIT ERROR:", e);
          alert("ADMIN INIT ERROR: cek Console (F12).");
        }
      }

      showPage("home");
    });

    /* expose for onclick */
    window.closeEditModal = closeEditModal;
    window.saveEditData = saveEditData;
    window.saveData = saveData;
    window.addKategori = addKategori;
  </script>
</body>
</html>
